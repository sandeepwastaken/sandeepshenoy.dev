<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phone Consoles</title>
  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .qr-container {
      display: flex;
      gap: 1em;
      margin: 1em;
    }
    .port {
      background: #222;
      padding: 1em;
      border-radius: 8px;
      border: 1px solid #444;
      text-align: center;
      filter: none;
      transition: 0.3s;
    }
    .port.claimed {
      filter: blur(4px);
    }
    canvas {
      background: #222;
      margin: 1em 0;
      border: 2px solid #333;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 10px;
      margin-top: 2em;
      justify-content: center;
    }
    .btn {
      background: #444;
      color: white;
      padding: 1em;
      text-align: center;
      border-radius: 8px;
      font-size: 1em;
      user-select: none;
    }
    .btn:active {
      background: #888;
    }
  </style>
</head>
<body>
  <h1>Room Console</h1>
  <div class="qr-container" id="qr-ports"></div>
  <canvas id="game" width="600" height="400"></canvas>

  <script>
    const ROOM_ID = new URLSearchParams(location.search).get("room") || Math.floor(Math.random() * 1000000).toString();
    const baseURL = location.origin + location.pathname;
    const PORTS = 3;
    const players = {};

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const pusher = new Pusher("03ce99c8313e1f6fee98", {
      cluster: "mt1"
    });

    const channel = pusher.subscribe(`room-${ROOM_ID}`);

    function randomColor() {
      return `hsl(${Math.floor(Math.random() * 360)}, 80%, 60%)`;
    }

    function drawPlayers() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const id in players) {
        const p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 40, 40);
        ctx.fillStyle = '#000';
        ctx.font = "20px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(p.mode, p.x + 20, p.y + 27);
      }
    }

    function updatePlayer(id, key) {
      if (!players[id]) {
        players[id] = {
          x: Math.random() * (canvas.width - 40),
          y: Math.random() * (canvas.height - 40),
          color: randomColor(),
          mode: ""
        };
      }
      const p = players[id];
      if (key === "left") p.x -= 10;
      if (key === "right") p.x += 10;
      if (key === "up") p.y -= 10;
      if (key === "down") p.y += 10;
      if (key === "space") p.color = randomColor();
      if (key === "a" || key === "b") p.mode = key.toUpperCase();
      drawPlayers();
    }

    channel.bind("connect", data => {
      const el = document.getElementById(`qr-${data.id}`);
      if (el) el.parentElement.classList.add("claimed");
    });

    channel.bind("input", data => {
      updatePlayer(data.id, data.key);
    });

    // QR Generation
    const qrDiv = document.getElementById("qr-ports");
    for (let i = 0; i < PORTS; i++) {
      const portId = `port-${i}`;
      const url = `${baseURL}?room=${ROOM_ID}&port=${i}#phone`;
      const portEl = document.createElement("div");
      portEl.className = "port";
      portEl.innerHTML = `<div><strong>Port ${i + 1}</strong></div><canvas id="qr-${portId}"></canvas>`;
      qrDiv.appendChild(portEl);
      QRCode.toCanvas(document.getElementById(`qr-${portId}`), url);
    }

    // If phone controller
    if (location.hash === "#phone") {
      const port = new URLSearchParams(location.search).get("port");
      const id = `port-${port}`;

      // Send "connect" event
      fetch("https://sandbox.pusher.com/publish", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          channel: `room-${ROOM_ID}`,
          name: "connect",
          data: { id }
        })
      });

      document.body.innerHTML = `<h2>Phone Controller</h2><div class="controls" id="buttons"></div>`;

      const buttonMap = {
        "←": "left",
        "→": "right",
        "↑": "up",
        "↓": "down",
        "A": "a",
        "B": "b",
        "␣": "space"
      };

      const buttons = document.getElementById("buttons");
      for (const [label, key] of Object.entries(buttonMap)) {
        const btn = document.createElement("div");
        btn.className = "btn";
        btn.textContent = label;
        btn.onclick = () => {
          fetch("https://sandbox.pusher.com/publish", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              channel: `room-${ROOM_ID}`,
              name: "input",
              data: { id, key }
            })
          });
        };
        buttons.appendChild(btn);
      }
    }
  </script>
</body>
</html>
