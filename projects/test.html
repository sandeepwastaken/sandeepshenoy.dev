<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phone Consoles</title>
  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      overflow: hidden;
    }
    canvas {
      background: #222;
      border: 2px solid #333;
      margin-top: 1em;
    }
    .qr-container {
      display: flex;
      gap: 1em;
      margin: 1em;
    }
    .port {
      text-align: center;
      background: #222;
      padding: 1em;
      border-radius: 8px;
      border: 1px solid #444;
    }
    .port canvas.claimed {
      filter: blur(4px) grayscale(1);
    }
    .controller {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .btn {
      width: 60px;
      height: 60px;
      font-size: 20px;
      border: none;
      border-radius: 8px;
      background: #333;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Room Console</h1>
  <div class="qr-container" id="qr-ports"></div>
  <canvas id="game" width="600" height="400"></canvas>

  <script>
    const ROOM_ID = new URLSearchParams(location.search).get("room") || (Math.floor(Math.random() * 1000000)).toString();
    const PORTS = 3;
    const CLAIMED_PORTS = new Set();
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const players = {};

    function randomColor() {
      return `hsl(${Math.floor(Math.random() * 360)}, 80%, 60%)`;
    }

    function drawPlayers() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const id in players) {
        const p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 40, 40);
        ctx.fillStyle = '#000';
        ctx.font = "20px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(p.mode, p.x + 20, p.y + 27);
      }
    }

    function updatePlayer(id, key) {
      if (!players[id]) {
        players[id] = {
          x: Math.random() * (canvas.width - 40),
          y: Math.random() * (canvas.height - 40),
          color: randomColor(),
          mode: ""
        };
      }
      const p = players[id];
      if (key === "left") p.x -= 10;
      if (key === "right") p.x += 10;
      if (key === "up") p.y -= 10;
      if (key === "down") p.y += 10;
      if (key === "space") p.color = randomColor();
      if (key === "a" || key === "b") p.mode = key.toUpperCase();
      drawPlayers();
    }

    // Pusher setup
    Pusher.logToConsole = false;
    const pusher = new Pusher("03ce99c8313e1f6fee98", {
      cluster: "mt1",
      encrypted: true
    });
    const channel = pusher.subscribe(`room-${ROOM_ID}`);

    channel.bind("input", data => {
      updatePlayer(data.id, data.key);
    });

    channel.bind("connect", data => {
      const canvas = document.getElementById(`qr-${data.port}`);
      if (canvas) canvas.classList.add("claimed");
    });

    // Generate QR codes
    const qrDiv = document.getElementById("qr-ports");
    for (let i = 0; i < PORTS; i++) {
      const portId = `${ROOM_ID}-port-${i}`;
      const phoneURL = `${location.origin + location.pathname}?room=${ROOM_ID}&port=${i}#phone`;
      const container = document.createElement("div");
      container.className = "port";
      container.innerHTML = `<div><strong>Port ${i + 1}</strong></div>`;

      const canvas = document.createElement("canvas");
      canvas.id = `qr-${i}`;
      container.appendChild(canvas);
      qrDiv.appendChild(container);

      QRCode.toCanvas(canvas, phoneURL).catch(console.error);
    }

    // Phone controller page
    if (location.hash === "#phone") {
      const port = new URLSearchParams(location.search).get("port") || "0";
      const id = `port-${port}`;

      document.body.innerHTML = `
        <h2>Phone Controller</h2>
        <div id="status">Connected as ${id}</div>
        <div class="controller">
          <button class="btn" data-key="left">←</button>
          <button class="btn" data-key="up">↑</button>
          <button class="btn" data-key="down">↓</button>
          <button class="btn" data-key="right">→</button>
          <button class="btn" data-key="space">⭘</button>
          <button class="btn" data-key="a">A</button>
          <button class="btn" data-key="b">B</button>
        </div>`;

      const send = key => {
        fetch("https://cors-anywhere.herokuapp.com/https://sandbox.pusher.com/publish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            channel: `room-${ROOM_ID}`,
            name: "input",
            data: { id, key }
          })
        });
      };

      fetch("https://cors-anywhere.herokuapp.com/https://sandbox.pusher.com/publish", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          channel: `room-${ROOM_ID}`,
          name: "connect",
          data: { id, port }
        })
      });

      document.querySelectorAll(".btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.key;
          send(key);
        });
      });
    }
  </script>
</body>
</html>